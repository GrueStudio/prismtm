{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Prism Project Configuration",
  "description": "Schema for project.yml - main project configuration and hierarchy",
  "type": "object",
  "properties": {
    "meta": {
      "type": "object",
      "properties": {
        "name": {"type": "string", "minLength": 1},
        "description": {"type": "string"},
        "version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+(-\\w+)?$"},
        "created_at": {"type": "string", "format": "date-time"},
        "updated_at": {"type": "string", "format": "date-time"}
      },
      "required": ["name", "version", "created_at", "updated_at"],
      "additionalProperties": false
    },
    "navigation": {
      "type": "object",
      "properties": {
        "current_phase_id": {"type": ["string", "null"], "format": "uuid"},
        "current_milestone_id": {"type": ["string", "null"], "format": "uuid"},
        "current_block_id": {"type": ["string", "null"], "format": "uuid"},
        "current_task_id": {"type": ["string", "null"], "format": "uuid"},
        "current_subtask_id": {"type": ["string", "null"], "format": "uuid"}
      },
      "additionalProperties": false
    },
    "timer": {
      "type": ["object", "null"],
      "properties": {
        "target_id": {"type": "string", "format": "uuid"},
        "target_type": {"type": "string", "enum": ["phase", "milestone", "block", "task", "subtask"]},
        "state": {"type": "string", "enum": ["stopped", "running", "paused"]},
        "session": {
          "type": "object",
          "properties": {
            "id": {"type": "string", "format": "uuid"},
            "start_time": {"type": "string", "format": "date-time"},
            "end_time": {"type": ["string", "null"], "format": "date-time"},
            "duration_seconds": {"type": "number", "minimum": 0},
            "notes": {"type": "string"}
          },
          "required": ["id", "start_time", "duration_seconds"],
          "additionalProperties": false
        }
      },
      "required": ["target_id", "target_type", "state"],
      "additionalProperties": false
    },
    "phases": {
      "type": "object",
      "patternProperties": {
        "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$": {
          "$ref": "#/definitions/phase"
        }
      },
      "additionalProperties": false
    }
  },
  "required": ["meta", "navigation", "phases"],
  "additionalProperties": false,
  "definitions": {
    "timestamp_mixin": {
      "type": "object",
      "properties": {
        "created_at": {"type": "string", "format": "date-time"},
        "updated_at": {"type": "string", "format": "date-time"}
      },
      "required": ["created_at", "updated_at"]
    },
    "time_trackable": {
      "type": "object",
      "properties": {
        "total_time_seconds": {"type": "number", "minimum": 0},
        "active_sessions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": {"type": "string", "format": "uuid"},
              "start_time": {"type": "string", "format": "date-time"},
              "end_time": {"type": ["string", "null"], "format": "date-time"},
              "duration_seconds": {"type": "number", "minimum": 0},
              "notes": {"type": "string"}
            },
            "required": ["id", "start_time", "duration_seconds"],
            "additionalProperties": false
          }
        }
      },
      "required": ["total_time_seconds", "active_sessions"]
    },
    "base_task_properties": {
      "allOf": [
        {"$ref": "#/definitions/timestamp_mixin"},
        {"$ref": "#/definitions/time_trackable"},
        {
          "type": "object",
          "properties": {
            "id": {"type": "string", "format": "uuid"},
            "title": {"type": "string", "minLength": 1},
            "description": {"type": "string"},
            "status": {
              "type": "string",
              "enum": ["todo", "in_progress", "paused", "blocked", "completed", "cancelled"]
            },
            "tags": {
              "type": "array",
              "items": {"type": "string"},
              "uniqueItems": true
            },
            "dependencies": {
              "type": "array",
              "items": {"type": "string", "format": "uuid"},
              "uniqueItems": true
            },
            "estimated_time_seconds": {"type": ["number", "null"], "minimum": 0},
            "priority": {"type": "integer"},
            "assignee": {"type": ["string", "null"]}
          },
          "required": ["id", "title", "status", "tags", "dependencies", "priority"]
        }
      ]
    },
    "subtask": {
      "$ref": "#/definitions/base_task_properties"
    },
    "task": {
      "allOf": [
        {"$ref": "#/definitions/base_task_properties"},
        {
          "type": "object",
          "properties": {
            "subtasks": {
              "type": "object",
              "patternProperties": {
                "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$": {
                  "$ref": "#/definitions/subtask"
                }
              },
              "additionalProperties": false
            }
          },
          "required": ["subtasks"]
        }
      ]
    },
    "block": {
      "allOf": [
        {"$ref": "#/definitions/base_task_properties"},
        {
          "type": "object",
          "properties": {
            "version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+(-\\w+)?$"},
            "release_date": {"type": ["string", "null"], "format": "date-time"},
            "tasks": {
              "type": "object",
              "patternProperties": {
                "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$": {
                  "$ref": "#/definitions/task"
                }
              },
              "additionalProperties": false
            }
          },
          "required": ["version", "tasks"]
        }
      ]
    },
    "milestone": {
      "allOf": [
        {"$ref": "#/definitions/base_task_properties"},
        {
          "type": "object",
          "properties": {
            "version_pattern": {"type": "string", "pattern": "^\\d+\\.\\d+\\.x$"},
            "target_date": {"type": ["string", "null"], "format": "date-time"},
            "blocks": {
              "type": "object",
              "patternProperties": {
                "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$": {
                  "$ref": "#/definitions/block"
                }
              },
              "additionalProperties": false
            }
          },
          "required": ["version_pattern", "blocks"]
        }
      ]
    },
    "phase": {
      "allOf": [
        {"$ref": "#/definitions/base_task_properties"},
        {
          "type": "object",
          "properties": {
            "target_date": {"type": ["string", "null"], "format": "date-time"},
            "milestones": {
              "type": "object",
              "patternProperties": {
                "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$": {
                  "$ref": "#/definitions/milestone"
                }
              },
              "additionalProperties": false
            }
          },
          "required": ["milestones"]
        }
      ]
    }
  }
}